---
title: "REddyProc for Eddy Covariance Data Analysis"
author: "Yusri Yusup"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Step 1: Prepare the Data
## Step 1-1: Import the Data

The data that will be used is included in the package for demo purposes.
Data:
1. DEGebExample: Gebesee, Germany, data from 2004 to 2006. It is downloadable at http://www.europe-fluxdata.eu/home/site-details?id=3 after registration.
2. Example_DETha98: Tharandt, Germany, data for the year 1998. 

The package wesbite is at https://bgc.iwww.mpg.de/5622399/REddyProc
```{r Importing and Previewing the Data}

library(REddyProc)
data(DEGebExample)
data(Example_DETha98)
# Gebesee, Germany, data 
summary(DEGebExample)
# Tharandt, Germany, data
summary(Example_DETha98)

```
## Step 1-2: Calculate Needed Paramters

Essential parameters can be calculated from available parameters using function
built in REddyProc.

Useful functions:
1. fCalcVPDfromRHandTair(...)
2. fCalcETfromLE(...) 
3. fConvertTimeToPosix(...)
4. fConvertCtoK(...)

## Step 1-3-1: Tharandt Dataset: Unsupported Timestamp Format
In the Tharandt dataset, the time columns are not suitable for further analysis
in REddyProc. It needs to be converted.

```{r Unsupported Timestamp Format}
head(Example_DETha98)
Example_DETha98V1 <- fConvertTimeToPosix(Example_DETha98, TFormat = c('YDH'),
                    Year = 'Year',
                    Day = 'DoY', 
                    Hour = 'Hour')
head(Example_DETha98V1)
```
## Step 1-3-2: Gebesee Dataset: Missing VPD

Meanwhile, the DEGeb dataset does not have the VPD parameter that could be 
useful for gap-filling and partitioning.

```{r Missing VPD}
head(DEGebExample)
VPD <- fCalcVPDfromRHandTair(DEGebExample$rH, DEGebExample$Tair)
DEGebExampleV1 <- cbind(DEGebExample,VPD)
head(DEGebExampleV1)
```
# Step 2: Create REddyProc Object Class

Before REddyProc can work on your data, the data has to be converted to a REddyProc object.

## Tharandt (Forest Area, Timezone = +2)
The Anchor Station Tharandt (50.96235°N, 13.56516°E, 385 m a.s.l.) is located in the Eastern part of a large forested area (60 km²) near the city of Tharandt, about 25 km SW of Dresden. This forest has a long history of forestry documentation as well as meteorological and hydrological measurements. The spruce stand at the Anchor Station Tharandt was established by seeding in 1887. Besides the dominating spruce trees some additional tree species are present: in the vicinity of the measurement tower (500 m ra ????

## Gebesee (Agricultural Area, TimeZone = +1)
the study site is located near the village Gebesee about 20 km NW of Erfurt, the station is located in the middle of an agricultural field, an approximate ...51.0997, 10.9146
```{r Create Class}
?sEddyProc_initialize  # called by sEddyProc$new
?sEddyProc_sSetLocationInfo

# Tharandt Data
EProcDETha <- sEddyProc$new('DE-Tha', Example_DETha98V1, c('NEE','Rg','Tair','VPD','Ustar'))
EProcDETha$sLOCATION
## Location of Tharandt
EProcDETha$sSetLocationInfo(LatDeg = 51.0, LongDeg = 13.6, TimeZoneHour = 2)
EProcDETha$sLOCATION

# Gebesee Data
EProcDEGeb <- sEddyProc$new('DE-Geb', DEGebExampleV1, c('NEE','Rg','Tair','VPD','Ustar'))
EProcDEGeb$sLOCATION
## Location of Gebesee
EProcDEGeb$sSetLocationInfo(LatDeg = 51.1, LongDeg = 10.9, TimeZoneHour = 1)  
EProcDEGeb$sLOCATION

```
# Step 3: u*-Threshold Estimation

Based on the NEE plot, define seasons starting 
at day 70, 210, 320 in 2004 and 70,180,320 in 2005 and 120,305 in 2006.

We do this because u* changes with surface cover change. The dates of when the
surface changes need to be determined prior to analysis or it can be inspected 
from the data visually.

## Step 3-2: Gebesee Dataset
```{r u*-Threshold Estimation}

df_startDays <- data.frame(day=c(70,210,320,70,180,320,120,305),
                           year=c(2004,2004,2004,2005,2005,2005,2006,2006))

df_startDays

# 15*60 is used to make sure the factor is within a row of the data
seasonFactor <- usCreateSeasonFactorYdayYear(DEGebExampleV1$DateTime - 15*60,
                                             starts = df_startDays)

seasonStartsDate <- fConvertTimeToPosix(
  data.frame(Year = df_startDays$year, 
             DoY = df_startDays$day, 
             Hour = 0.25), 
  'YDH', 
  Year = "Year", 
  Day = "DoY", 
  Hour = "Hour")
seasonStartsDate

```
## Step 3-2-1: Check the Season Starting Dates

You can check the dates by plotting them on the time series.


```{r Check the Season Starting Dates}

plot(DEGebExample$DateTime, DEGebExample$NEE)
abline( v = seasonStartsDate$DateTime)
```
# Step 3-2-3: Determine u*-Thresholds Distributions

Specify the seasons defined before.

For saving time, here use only 30 bootstrap samples (argument nSample) and 
estimate only the 10th and 90th percentile (argument probs)

Print the estimated thresholds.

```{r Determine u*-Thresholds Distributions}

EProcDEGeb$sEstimateUstarScenarios(seasonFactor = seasonFactor, nSample = 10,
                                   probs = c(0.05,0.5,0.95))
EProcDEGeb$sGetEstimatedUstarThresholdDistribution()



```
# Step 4-1: Gap-Filling


## Task 2a: Use seasonal u* thresholds

- display the default annually used thresholds
- specify using seasonsal thresholds
- display the scenarios again

```{r Gap-Filling}

#?sEddyProc_sGetUstarScenarios
#?sEddyProc_useSeaonsalUStarThresholds

EProcDEGeb$sGetUstarScenarios()
EProcDEGeb$useSeaonsalUStarThresholds()
EProcDEGeb$sGetUstarScenarios()


```
# Step 4-2: Gap-Filling

Estimate random error also for non-gap records.

```{r Gap-Filling}

EProcDEGeb$sMDSGapFillUStarScens("NEE", FillAll = TRUE)

```
What columns have been created?

For an explanation of the column names see [output format description](https://www.bgc-jena.mpg.de/bgi/index.php/Services/REddyProcWebOutput)
- NEE_<scenario>_f: gaps replaced by modeled values (gapfilled)
- NEE_<scenario>_fall: all NEE replaced by modeled values
- NEE_<scenario>_fqc: quality flag: 0 observations, 1 good quality of gapfilling 

```{r }
colnames(EProcDEGeb$sExportResults())
```
# Step 4-3: Plot Fingerprint Plot

First a single plot in document
- for 90% quantile $u_{*Th}$ (suffix U90)
- for year 2005

```{r }
EProcDEGeb$sPlotFingerprintY('NEE_U95_f', Year = 2005)
```

Next, produce pdf-files with legend for all years in subdirectory "figs"

```{r}
#?sEddyProc_sPlotFingerprint

EProcDEGeb$sPlotFingerprint('NEE_U95_f', Dir = "figs")
```

# Step 5-1: Flux Partitioning

## Task 3a: Prepare for partitioning
Specify the Location and time zone (51.1N, 10.0W, 1 hour ahead of GMT)

Gapfill the necessary meteorological input variables (Rg, Tair, VPD). Here
we do not need computing the uncertainty of the non-filled records.

```{r, message=FALSE}


EProcDEGeb$sMDSGapFill('Rg', FillAll = FALSE)     
EProcDEGeb$sMDSGapFill('Tair', FillAll = FALSE)     
EProcDEGeb$sMDSGapFill('VPD', FillAll = FALSE)     
```

## Task 3b: Nighttime partitioning
Perform the nighttime partitioning

```{r, message=FALSE}

EProcDEGeb$sMRFluxPartitionUStarScens()
```

## Task 3c: Plotting the head GPP
Query the result data.frame to variable dsResults
```{r}

dsResults <- EProcDEGeb$sExportResults()
```

Plot the head of GPP for U95 scenario against time (DEGebExample$DateTime)
```{r}
nRec = 48*4 # 4 days of half-hours
plot(head(dsResults$GPP_U95_f,nRec) ~ head(DEGebExampleV1$DateTime, nRec), type = "l")
```


## Task3d: Daytime partitioning
Perform the daytime partitioning.

```{r, message=FALSE}

EProcDEGeb$sGLFluxPartitionUStarScens()
```

## Task 3e: Produce fingerprint plots of GPP_DT and Reco_DT 
- For the original non-bootstrapped data uStar scenario (suffix uStar)
- In Sub-Directory `plotsHandsOn`
```{r}
?sEddyProc_sPlotFingerprint

EProcDEGeb$sPlotFingerprint("GPP_DT_uStar",Dir = "figs")
EProcDEGeb$sPlotFingerprint("Reco_DT_uStar",Dir = "figs")
```

## Task 3f: Save the results together with the data
as tab-delimted text file "plotsHandsOn/DEGeb_Part.txt"
Store the combined data and results in variable 'results'
```{r}

dsRes <- EProcDEGeb$sExportResults()
dsData <- EProcDEGeb$sExportData()
results <- cbind(dsData, dsRes)
fWriteDataframeToFile(results, "DE-Geb_Part.txt", Dir = "results")
```

```{r }

```



```{r }

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
